<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Spectral index calculation from a STAC item — ngr_spk_stac_calc • ngr</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spectral index calculation from a STAC item — ngr_spk_stac_calc"><meta name="description" content="Compute a spectral index for a single STAC item. By default, the function reads
red and near-infrared (NIR) assets to compute NDVI, but this is only the
default configuration. The function is designed to read any two or three
assets and apply different spectral index calculations as they are added in
the future."><meta property="og:description" content="Compute a spectral index for a single STAC item. By default, the function reads
red and near-infrared (NIR) assets to compute NDVI, but this is only the
default configuration. The function is designed to read any two or three
assets and apply different spectral index calculations as they are added in
the future."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ngr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/stac-spectral-indices.html">STAC spectral indices with ngr_spk_stac_calc</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NewGraphEnvironment/ngr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spectral index calculation from a STAC item</h1>
      <small class="dont-index">Source: <a href="https://github.com/NewGraphEnvironment/ngr/blob/main/R/ngr_spk_stac_calc.R" class="external-link"><code>R/ngr_spk_stac_calc.R</code></a></small>
      <div class="d-none name"><code>ngr_spk_stac_calc.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Compute a spectral index for a single STAC item. By default, the function reads
red and near-infrared (NIR) assets to compute NDVI, but this is only the
default configuration. The function is designed to read any two or three
assets and apply different spectral index calculations as they are added in
the future.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">ngr_spk_stac_calc</span><span class="op">(</span></span>
<span>  <span class="va">feature</span>,</span>
<span>  aoi <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  asset_a <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>  asset_b <span class="op">=</span> <span class="st">"nir08"</span>,</span>
<span>  asset_c <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  calc <span class="op">=</span> <span class="st">"ndvi"</span>,</span>
<span>  vsi_prefix <span class="op">=</span> <span class="st">"/vsicurl/"</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  timing <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-feature">feature<a class="anchor" aria-label="anchor" href="#arg-feature"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a> A single STAC Item (one element from an <code>items$features</code>
list).</p></dd>


<dt id="arg-aoi">aoi<a class="anchor" aria-label="anchor" href="#arg-aoi"></a></dt>
<dd><p><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">sf::sf</a> or <a href="https://rdrr.io/r/base/NULL.html" class="external-link">NULL</a> Optional. An AOI object used to restrict reads (by
bbox) and to crop and mask the output. If <code>NULL</code>, the full assets are read and
no crop/mask is applied. Default is <code>NULL</code>.</p></dd>


<dt id="arg-asset-a">asset_a<a class="anchor" aria-label="anchor" href="#arg-asset-a"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a> Optional. A single string giving the asset name for
the first input band. For NDVI this corresponds to the red band. Default is
<code>"red"</code>.</p></dd>


<dt id="arg-asset-b">asset_b<a class="anchor" aria-label="anchor" href="#arg-asset-b"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a> Optional. A single string giving the asset name for
the second input band. For NDVI this corresponds to the NIR band. Default is
<code>"nir08"</code>.</p></dd>


<dt id="arg-asset-c">asset_c<a class="anchor" aria-label="anchor" href="#arg-asset-c"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a> or <a href="https://rdrr.io/r/base/NULL.html" class="external-link">NULL</a> Optional. A single string giving the asset
name for an optional third input band, used by some calculations. Default is
<code>NULL</code>.</p></dd>


<dt id="arg-vsi-prefix">vsi_prefix<a class="anchor" aria-label="anchor" href="#arg-vsi-prefix"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a> Optional. A single string giving the GDAL VSI
prefix used by <code><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">terra::rast()</a></code> to enable streaming, windowed reads over HTTP.
Exposed to allow alternative VSI backends (e.g. <code>/vsis3/</code>). Default is
<code>"/vsicurl/"</code>.</p></dd>


<dt id="arg-quiet">quiet<a class="anchor" aria-label="anchor" href="#arg-quiet"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a> Optional. If <code>TRUE</code>, suppress CLI messages. Default is
<code>FALSE</code>.</p></dd>


<dt id="arg-timing">timing<a class="anchor" aria-label="anchor" href="#arg-timing"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a> Optional. If <code>TRUE</code>, emit simple elapsed-time messages
for reads. Default is <code>FALSE</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">terra::SpatRaster</a> with calculated index values.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The default asset names (<code>"red"</code> and <code>"nir08"</code>) align with common conventions
in Landsat Collection 2 Level-2 STAC items (e.g. the <code>landsat-c2-l2</code> collection
on Planetary Computer), but are fully parameterized to support other
collections with different band naming schemes.</p>
<p>This function expects <code>feature</code> to provide the required <code>assets</code> referenced by
<code>asset_a</code>, <code>asset_b</code>, and (if used) <code>asset_c</code>. When <code>aoi</code> is not <code>NULL</code>,
<code>feature</code> must also have <code>properties$"proj:epsg"</code> so the AOI can be transformed
for windowed reads.</p>
<p>The calculation performed is controlled by <code>calc</code>. By default, <code>calc = "ndvi"</code>
computes the Normalized Difference Vegetation Index using <code>(b - a) / (b + a)</code>.
This structure allows additional spectral indices (e.g. NDWI, EVI) to be added
in the future without changing the data access or cropping logic.</p>
<p>When <code>aoi</code> is provided, reading is limited to the AOI bounding box in the
feature's projected CRS, and then cropped/masked to the AOI. When <code>aoi = NULL</code>,
the full assets are read and the calculated raster is returned for the full
raster extent.</p>
    </div>
    <div class="section level2">
    <h2 id="production-ready-alternative">Production-ready alternative<a class="anchor" aria-label="anchor" href="#production-ready-alternative"></a></h2>


<p>This function is a proof of concept demonstrating how to perform raster
calculations on STAC items using <code>terra</code>. For production workflows involving
time series reductions, multi-image composites, or data cubes with varying
pixel sizes and coordinate reference systems, consider the
<a href="https://github.com/appelmar/gdalcubes" class="external-link">gdalcubes</a> package. Key functions
include:</p><ul><li><p><code>gdalcubes::stac_image_collection()</code>: Create an image collection
directly from STAC query results with automatic band detection and VSI
prefix handling.</p></li>
<li><p><code>gdalcubes::cube_view()</code>: Define spatiotemporal extent, resolution,
aggregation, and resampling method in a single specification.</p></li>
<li><p><code>gdalcubes::raster_cube()</code>: Build a data cube from an image
collection, automatically reprojecting and resampling images to a common
grid.</p></li>
<li><p><code>gdalcubes::apply_pixel()</code>: Apply arithmetic expressions (e.g.,
<code>"(nir - red) / (nir + red)"</code>) across all pixels.</p></li>
<li><p><code>gdalcubes::reduce_time()</code>: Temporal reductions (mean, median, max,
etc.) to composite multi-date imagery.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">terra::rast()</a></code>, <code><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">terra::crop()</a></code>, <code><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">terra::mask()</a></code>, <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">sf::st_transform()</a></code></p>
<p>Other spacehakr:
<code><a href="ngr_spk_gdalwarp.html">ngr_spk_gdalwarp()</a></code>,
<code><a href="ngr_spk_join.html">ngr_spk_join()</a></code>,
<code><a href="ngr_spk_layer_info.html">ngr_spk_layer_info()</a></code>,
<code><a href="ngr_spk_odm.html">ngr_spk_odm()</a></code>,
<code><a href="ngr_spk_poly_to_points.html">ngr_spk_poly_to_points()</a></code>,
<code><a href="ngr_spk_q_layer_info.html">ngr_spk_q_layer_info()</a></code>,
<code><a href="ngr_spk_rast_ext.html">ngr_spk_rast_ext()</a></code>,
<code><a href="ngr_spk_rast_not_empty.html">ngr_spk_rast_not_empty()</a></code>,
<code><a href="ngr_spk_rast_rm_empty.html">ngr_spk_rast_rm_empty()</a></code>,
<code><a href="ngr_spk_res.html">ngr_spk_res()</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># STAC query against Planetary Computer (Landsat C2 L2)</span></span></span>
<span class="r-in"><span><span class="va">stac_url</span> <span class="op">&lt;-</span> <span class="st">"https://planetarycomputer.microsoft.com/api/stac/v1"</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span></span>
<span class="r-in"><span><span class="va">date_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">y</span>, <span class="st">"-05-01/"</span>, <span class="va">y</span>, <span class="st">"-07-30"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define an AOI from a bounding box (WGS84)</span></span></span>
<span class="r-in"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  xmin <span class="op">=</span> <span class="op">-</span><span class="fl">126.55350240037997</span>,</span></span>
<span class="r-in"><span>  ymin <span class="op">=</span>  <span class="fl">54.4430453753869</span>,</span></span>
<span class="r-in"><span>  xmax <span class="op">=</span> <span class="op">-</span><span class="fl">126.52422763064457</span>,</span></span>
<span class="r-in"><span>  ymax <span class="op">=</span>  <span class="fl">54.46001902038006</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">aoi</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">bbox</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">stac_query</span> <span class="op">&lt;-</span> <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac.html" class="external-link">stac</a></span><span class="op">(</span><span class="va">stac_url</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/stac_search.html" class="external-link">stac_search</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    collections <span class="op">=</span> <span class="st">"landsat-c2-l2"</span>,</span></span>
<span class="r-in"><span>    datetime <span class="op">=</span> <span class="va">date_time</span>,</span></span>
<span class="r-in"><span>    intersects <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">aoi</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>    limit <span class="op">=</span> <span class="fl">200</span></span></span>
<span class="r-in"><span>  <span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/ext_filter.html" class="external-link">ext_filter</a></span><span class="op">(</span><span class="va">`eo:cloud_cover`</span> <span class="op">&lt;=</span> <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">items</span> <span class="op">&lt;-</span> <span class="va">stac_query</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/request.html" class="external-link">post_request</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/items_functions.html" class="external-link">items_fetch</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/items_sign_planetary_computer.html" class="external-link">items_sign_planetary_computer</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">ndvi_list</span> <span class="op">&lt;-</span> <span class="va">items</span><span class="op">$</span><span class="va">features</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">ngr_spk_stac_calc</span>, aoi <span class="op">=</span> <span class="va">aoi</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">ndvi_list</span> <span class="op">&lt;-</span> <span class="va">ndvi_list</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">items</span><span class="op">$</span><span class="va">features</span>, <span class="st">"id"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Allan Irvine.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

