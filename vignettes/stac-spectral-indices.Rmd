---
title: "STAC spectral indices with ngr_spk_stac_calc"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{STAC spectral indices with ngr_spk_stac_calc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  # echo = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ngr)
```

This vignette demonstrates computing NDVI from Landsat imagery using STAC APIs. The
`ngr_spk_stac_calc()` function provides a simple proof-of-concept approach using
`terra`. For production workflows involving time series, composites, or data cubes,
see the [gdalcubes](https://github.com/appelmar/gdalcubes) package.

## Single Year Example

Define an area of interest and query the Planetary Computer STAC catalog for
Landsat Collection 2 Level-2 imagery with low cloud cover.

```{r rstac-query-2000}
# Define an AOI from a bounding box (WGS84)
bbox <- c(
  xmin = -126.55350240037997,
  ymin =  54.4430453753869,
  xmax = -126.52422763064457,
  ymax =  54.46001902038006
)

aoi <- sf::st_as_sfc(sf::st_bbox(bbox, crs = 4326)) |>
  sf::st_as_sf()

stac_url <- "https://planetarycomputer.microsoft.com/api/stac/v1"
y <- 2000
date_time <- paste0(y, "-05-01/", y, "-09-15")

stac_query <- rstac::stac(stac_url) |>
  rstac::stac_search(
    collections = "landsat-c2-l2",
    datetime = date_time,
    intersects = sf::st_geometry(aoi)[[1]],
    limit = 200
  ) |>
  rstac::ext_filter(`eo:cloud_cover` <= 20)

items <- stac_query |>
  rstac::post_request() |>
  rstac::items_fetch() |>
  rstac::items_sign_planetary_computer()

```

Compute NDVI for each returned scene using `ngr_spk_stac_calc()`, which reads the
red and NIR bands via GDAL's VSI interface and calculates `(NIR - red) / (NIR + red)`.

```{r calc-ndvi-2000}
ndvi_list <- items$features |>
  purrr::map(ngr_spk_stac_calc, aoi = aoi, timing = TRUE) |>
  purrr::set_names(purrr::map_chr(items$features, "id"))
```

Create a mapview object for each NDVI raster with a red-yellow-green color scale.

```{r mapview-2000}
mv <- purrr::imap(
  ndvi_list,
  function(x, nm) {
    rng <- terra::minmax(x)
    at <- seq(
      floor(rng[1] * 10) / 10,
      ceiling(rng[2] * 10) / 10,
      by = 0.1
    )
    
    mapview::mapview(
      x,
      layer.name = nm,
      at = at,
      col.regions = grDevices::hcl.colors(length(at) - 1L, "RdYlGn")
    )
  }
)


```


Combine all layers into a single interactive map. Use the layer control (top-left)
to toggle individual scenes on/off.

```{r map1, out.width="100%"}
purrr::reduce(mv, `+`)
```

## Multi-Year Comparison

Query multiple years and select the best scene per year based on vegetation coverage
(highest proportion of pixels with NDVI >= 0.4). This helps identify scenes with
peak growing-season conditions.

```{r multi-year, eval=TRUE}
years <- seq(2000, 2025, by = 5)

ndvi_by_year <- purrr::set_names(years) |>
  purrr::map(function(y) {
    date_time <- paste0(y, "-06-01/", y, "-07-15")
    
    items <- rstac::stac(stac_url) |>
      rstac::stac_search(
        collections = "landsat-c2-l2",
        datetime = date_time,
        intersects = sf::st_geometry(aoi)[[1]],
        limit = 200
      ) |>
      rstac::ext_filter(`eo:cloud_cover` <= 50) |>
      rstac::post_request() |>
      rstac::items_fetch() |>
      rstac::items_sign_planetary_computer()
    
    items$features |>
      purrr::map(ngr_spk_stac_calc, aoi = aoi, timing = TRUE) |>
      purrr::set_names(purrr::map_chr(items$features, "id"))
  })

ndvi_best_by_year <- ndvi_by_year |>
  purrr::map(function(ndvi_list) {
    
    # Compute the proportion of pixels with NDVI >= 0.4 for each raster
    prop_high <- sapply(
      ndvi_list,
      \(r) terra::global(r >= 0.4, mean, na.rm = TRUE)[[1]]
    )
    
    ndvi_list[which.max(prop_high)]
  }) |> 
  purrr::keep(~ length(.x) > 0)

ndvi_flat <- purrr::imap(ndvi_best_by_year, \(lst, yr) {
  purrr::set_names(lst, paste0(yr, "__", names(lst)))
}) |>
  purrr::flatten()

mv <- purrr::imap(
  ndvi_flat,
  function(x, nm) {
    rng <- terra::minmax(x)
    at <- seq(
      floor(rng[1] * 10) / 10,
      ceiling(rng[2] * 10) / 10,
      by = 0.1
    )
    
    mapview::mapview(
      x,
      layer.name = nm,
      at = at,
      col.regions = grDevices::hcl.colors(length(at) - 1L, "RdYlGn")
    )
  }
)


```

Display the multi-year comparison. All year layers are visible by default; use the
layer control to toggle individual years on/off for comparison.

```{r map2, out.width="100%", eval = TRUE}
purrr::reduce(mv, `+`)
```

